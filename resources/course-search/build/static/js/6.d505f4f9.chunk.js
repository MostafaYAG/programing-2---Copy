(this["webpackJsonpcourse-search"]=this["webpackJsonpcourse-search"]||[]).push([[6],{569:function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));var r=a(81),n=Object(r.b)({key:"searchFormSubmittedState",default:{searchFormSubmitted:!1}})},576:function(e,t,a){"use strict";a.r(t),a.d(t,"fetchResults",(function(){return B})),a.d(t,"queryKeyName",(function(){return z}));var r=a(28),n=a.n(r),c=a(87),s=a(175),u=a(10),o=a(21),i=a(13),l=a(1),d=a(240),f=a(225),b=a(6),p=a(224),j=a(105),O=a(81),m=a(572),g=a(316),h=a(116),v=a.n(h),w=a(30),x=a(227),N=a(579),y=a(330),R=a(574),S=a(241),C=a(581),I=a(577),k=a(571),P=a(239),F=a(228),U=a(188),L=a(580),D=a(556),T=a(582),E=a(229),q=a(569),J=a(133),A=Object(N.a)(","),M=Object(y.a)(A,Object(R.a)(Boolean),Object(S.a)(parseInt)),Q=function(e){var t=Object(x.a)(e),a=t.featuredCourses?decodeURIComponent(t.featuredCourses):void 0,r=a?M(a):null;return Object(o.a)(Object(o.a)({},t),{},{featuredCourses:r})},B=function(e){var t=e.queryKey,a=e.pageParam,r=Q(window.location.href.split("?")[1]),n=t,c=Object(u.a)(n,7),s=(c[0],c[1]),o=c[2],i=c[3],l=c[4],f=c[5],b=c[6];return fetch("".concat(d.a,"/api/search-courses"),{method:"post",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({filters:i,page:a||s,size:void 0!==a?U.a:o,featuredCourses:a&&a>=1?r.featuredCourses:l,keyword:f?f.replace(/\+/g,"%20"):b&&r.keyword?b.replace(/\+/g,"%20"):void 0})}).then((function(e){return e.json()})).catch((function(e){throw new Error(e)}))},z="searchCourses",K=function(e){return function(t){var a=t.pages.findIndex((function(t){return t.courses.filter((function(t){return t.courseUID===e})).length}));if(a<0)return t;var r=t.pages[a].courses.findIndex((function(t){return t.courseUID===e}));return r<0?t:(function(e){var t=document.getElementsByClassName("btn-favourites-count").item(0);if(t){var a=parseInt(t.innerText,10);t.innerText="".concat(e?a+1:a-1)}}(!t.pages[a].courses[r].saved),Object(o.a)(Object(o.a)({},t),{},{pages:[].concat(Object(s.a)(t.pages.slice(0,a)),[Object(o.a)(Object(o.a)({},t.pages[a]),{},{courses:[].concat(Object(s.a)(t.pages[a].courses.slice(0,r)),[Object(o.a)(Object(o.a)({},t.pages[a].courses[r]),{},{saved:!t.pages[a].courses[r].saved})],Object(s.a)(t.pages[a].courses.slice(r+1)))})],Object(s.a)(t.pages.slice(a+1)))}))}},_={duration:0,a11y:!0};t.default=function(e){var t=e.title,a=e.searchData,r=a.featuredCourses,s=a.selectedSubjectText,h=a.subjectParam,N=void 0===h?"":h,y=a.page,R=a.size,S=a.searchParams,A=e.setSearch,M=Object(l.useRef)(),H=Object(l.useRef)(!1),W=[z,y,R,S,r,s,N],Y=Object(O.c)(q.a),G=Object(L.a)(W,B,{suspense:!0,refetchOnWindowFocus:!1,getNextPageParam:function(e){var t=Q(window.location.href.split("?")[1]),a="undefined"!==typeof t.page?parseInt(t.page,10):0;if(e&&e.totalNumberOfResults&&!(20*(a+1)>=e.totalNumberOfResults))return a+1}}),V=G.data,X=G.isFetchingNextPage,Z=G.fetchNextPage,$=G.hasNextPage,ee=G.status,te=Object(l.useRef)(),ae=Object(w.f)(),re=Object(J.a)(ae),ne=Object(D.b)(),ce=Object(T.a)((function(e){return v.a.get("".concat(d.e).concat(e),{withCredentials:!0})}),{onMutate:function(){var e=Object(c.a)(n.a.mark((function e(t){var a;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return H.current=!0,e.next=3,ne.cancelQueries(W);case 3:return a=ne.getQueryData(W),ne.setQueryData(W,K(t)),e.abrupt("return",{previousResults:a});case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),onError:function(e,t,a){ne.setQueryData(W,a.previousResults)}}),se=Object(w.e)(),ue=se.action,oe=se.replace,ie=se.location.search,le=Object(O.c)(g.a),de=Object(l.useRef)(),fe=Object(l.useRef)(null),be=Object(O.e)(E.a),pe=Object(l.useCallback)((function(e){if(e){var t=Object(x.a)(ie.substring(1)),a=Object(C.a)(I.a,t),r=sessionStorage.getItem(d.d),n=t.itemId;if(a("itemId")&&e.getAttribute("data-testid")===n){var c=Object(k.a)(["itemId"],t),s="".concat(new URLSearchParams(c));n&&(oe({search:s}),Object(m.a)(e,_))}r&&e.getAttribute("data-testid")===r&&(Object(m.a)(e,_),sessionStorage.removeItem(d.d))}}),[ie,oe]);Object(l.useEffect)((function(){window.dataLayer=window.dataLayer||[],M.current=window.dataLayer}),[]);var je=Object(l.useCallback)((function(){return Object(P.a)(ae.pathname,null===re||void 0===re?void 0:re.pathname)}),[ae.pathname,null===re||void 0===re?void 0:re.pathname]);if(Object(l.useEffect)((function(){if(!(!V||!V.pages||X||"success"!==ee||"number"===typeof de.current||H.current||Object(P.a)(V,te.current)&&je())){var e=!Y.searchFormSubmitted,t=window.location.href.split("?")[1],a=Object(x.a)(t),r=V.pages[0].featuredCourses;!function(){var e=document.querySelector(".nav-access");if(e){var t=document.createElement("LI");t.innerHTML="<a href='#results'>Skip to course search results</a>",e.insertBefore(t,e.childNodes[2])}}();var n=Object(o.a)(Object(o.a)({},a),V.pages.some((function(e){return e.courses.length}))?Object(o.a)({featuredCourses:r.join(",")||""},e&&!a.page||!e&&"POP"!==ue?{page:"0"}:(e&&a.page,null)):null),c=Object.entries(n).map((function(e){var t=Object(u.a)(e,2),a=t[0],r=t[1];return"".concat(encodeURIComponent(a),"=").concat(encodeURIComponent(r))})).join("&");e||fe.current&&Object(m.a)(fe.current,_),c!==t&&(oe({search:c}),be({totalNumberOfResults:V.pages[0].totalNumberOfResults}),A(!1),M.current.push({event:"courseSearch",courseSearchResults:V.pages[0].totalNumberOfResults}),te.current=V)}}),[V,X,ee,oe,be,A,R,Y.searchFormSubmitted]),Object(l.useEffect)((function(){if(!1===X&&"number"===typeof de.current&&V){window.scrollTo(0,de.current);var e=Object(x.a)(ie.substring(1));oe({search:"".concat(new URLSearchParams(Object(o.a)(Object(o.a)({},e),{},{page:(parseInt(e.page||window.__page,10)+1).toString()})))}),de.current=void 0}}),[X,ie,oe,V]),!V||null===V.pages[0].totalNumberOfResults)return null;var Oe=U.a;0===V.pages[0].totalNumberOfResults&&(t=j.b);var me=t===j.b?"":t,ge=V.pages[0].totalNumberOfResults-V.pages.reduce((function(e,t){return e+t.courses.length}),0);ge>Oe&&(ge=Oe);var he=function(){var e=Object(c.a)(n.a.mark((function e(){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:H.current=!1,de.current=window.pageYOffset,Z();case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),ve=function(){var e=Object(c.a)(n.a.mark((function e(t){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(le){e.next=2;break}return e.abrupt("return",window.location.href="".concat(d.a,"/postgraduate-courses/saveItem/courses?itemId=").concat(t));case 2:ce.mutate(t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),we="Show next ".concat(ge," match").concat(ge>1?"es":""),xe=function(e){return sessionStorage.setItem(d.d,e.toString())};return Object(i.jsxs)("main",{id:"results",children:[Object(i.jsx)(F.a,{children:Object(i.jsx)("title",{children:"".concat(""!==t?t:"Search postgraduate courses"," | Prospects.ac.uk")})}),Object(i.jsx)("div",{ref:fe,children:V.pages[0].totalNumberOfResults>0?Object(i.jsx)(f.a,{total:V.pages[0].totalNumberOfResults||0,text:me}):Object(i.jsx)(f.a,{})}),V.pages[0].totalNumberOfResults||V.pages.some((function(e){return e.courses.length}))?Object(i.jsx)(b.c,{children:Object(i.jsx)(b.l,{children:Object(i.jsx)(b.b,{width:[1,null,null,10/12,8/12],marginLeft:[0,null,null,Object(b.p)(1),Object(b.p)(2)],children:Object(i.jsx)("ul",{"data-testid":"course-search-results",children:V.pages.map((function(e){return e.courses.map((function(e){var t=e.courseUID,a=e.courseName,r=e.institutionSlug,n=e.institutionName,c=e.institutionProfile,s=e.departmentSlug,u=e.departmentName,o=e.departmentProfile,l=e.courseSlug,d=e.isFeatured,b=e.isNewFunding,p=e.qualifications,j=e.saved,O=e.startsJanuary;return Object(i.jsx)(f.b,{id:t,courseName:a,courseUrl:"/universities/".concat(r,"-").concat(n.tnr,"/").concat(s,"-").concat(u.tnr,"/courses/").concat(l,"-").concat(t),departmentName:u,departmentUrl:o&&"/universities/".concat(r,"-").concat(n.tnr,"/").concat(o.slug,"-").concat(o.tnrNumber),institutionName:n,institutionUrl:c&&"/universities/".concat(c.slug,"-").concat(c.tnrNumber),isFeatured:d,isNewFunding:b,qualifications:p,saved:j,loggedIn:le,handleToggleSave:ve,handleCourseLinkClick:xe,passedRef:pe,startsJanuary:O},t)}))}))})})})}):null,Object(i.jsx)(b.d,{justifyContent:"center",children:$?Object(i.jsx)(p.c,{onClick:he,element:"button",activity:X,width:"230px",dataTestId:"courseSearchResultsShowMore",children:we}):V.pages[0].totalNumberOfResults>=Oe||V.pages[0].totalNumberOfResults<Oe&&V.pages.some((function(e){return e.courses.length}))?Object(i.jsx)(b.h,{as:"p","data-testid":"courseSearchNoMoreCourses",textAlign:"center",textColor:"slateDark",fontFamily:"ne10",children:"No more matching courses"}):null})]})}}}]);
//# sourceMappingURL=6.d505f4f9.chunk.js.map